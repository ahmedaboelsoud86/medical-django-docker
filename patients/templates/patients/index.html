{% extends 'layout.html'%}
{% load static %}
{% block title %}Patients{% endblock %}
{% block css %}
<link href="{% static 'admin_assets/css/style.css' %}" rel="stylesheet" type="text/css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" type="text/css" />
{% endblock %}
{% block body %}
{% include "partials/_session.html" %}
<style>
    .checkbox-style {
        margin-left: 5px;
        margin-right: 5px;
    }

    .checkboxes {
        box-sizing: border-box;
        width: 15px;
        height: 15px;
        margin: 6px;
        padding: 0;
        border: 2px solid rgb(128, 128, 128);
    }
</style>
<div class="row">
    <div class="col-md-12">
        <div class="tile shadow">
            <div>
                <button type="button" style="border: none;" data-dismiss="modal" class="add_btn"
                    id="new">add_new_patient <i class="fa fa-plus"></i></button>
            </div>
            <ul class="breadcrumb mt-2">
                <li class="breadcrumb-item">Patients</li>
                <form method="post" action="{% url 'patients:deleteallpatient'  %}" style="display: inline-block;">
                    {% csrf_token %}
                    <input type="hidden" name="record_ids" id="record-ids">
                    <button type="submit" class="btn btn-default btn-sm   show-alert-delete-box" id="bulk-delete"
                        disabled="true"><i class="fa fa-trash"></i> Delete </button>
                </form><!-- end of form -->
            </ul>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <input type="text" id="title-search" name="title" class="form-control" placeholder="Name">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <select id="branch-search" name="branch" class="form-control">
                            <option value="">Select Branch</option>
                            {% for branch in branches %}
                            <option value="{{branch.id}}">{{branch.name}}</option>
                            {%endfor%}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <select id="gender-search" name="gender" class="form-control">
                            <option value="">Select Gender</option>
                            <option value="ma">Male</option>
                            <option value="fa">Female</option>
                        </select>
                    </div>
                </div>
            </div><!-- end of row -->
            <div class="row">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="datatables" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="table-checkbox">
                                    <input type="checkbox" id="record__select-all" class="group-checkable"
                                        data-set="#datatables  .checkboxes" />
                                </th>
                                <th>Patient Name</th>
                                <th>Branche</th>
                                <th>Mobile</th>
                                <th>Email</th>
                                <th>Gender</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                    </table>
                    <!-- Delete Modal -->
                    <div class="modal fade" id="confirm" role="dialog">
                        <div class="modal-dialog">
                            <!-- Modal content-->
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title">Are you sure?</h4>
                                </div>
                                <div class="modal-body">
                                    <button type="button" data-dismiss="modal" class="btn btn-primary"
                                        id="delete">Delete</button>
                                    <button type="button" data-dismiss="modal" class="btn">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- NEW and EDIT Modal -->
                    <div class="modal fade" id="myModal" role="dialog">
                        <div class="modal-dialog">
                            <!-- Modal content-->
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title" id="modal_title"></h4>
                                </div>
                                <div class="modal-body">
                                    <form role="form" id="form">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="song">
                                                        Branches </label>
                                                    <select id="branch" name="branch" class="form-control">
                                                        <option value="">Select Branche</option>
                                                        {% for branch in branches %}
                                                        <option value="{{branch.id}}">{{branch.name}}</option>
                                                        {%endfor%}
                                                    </select>
                                                    <span id="branch-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="gender">
                                                        Gender</label>
                                                    <select id="gender" name="gender" class="form-control">
                                                        <option value="">Select Gender</option>
                                                        <option value="ma">Male</option>
                                                        <option value="fa">Female</option>
                                                    </select>
                                                    <span id="gender-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="title">
                                                        Name</label>
                                                    <input type="text" id="title" name="title" class="form-control" />
                                                    <span id="title-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="email">
                                                        Email</label>
                                                    <input type="email" id="email" name="email" class="form-control" />
                                                    <span id="email-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="mobile">
                                                        Mobile</label>
                                                    <input type="numer" id="mobile" name="mobile"
                                                        class="form-control" />
                                                    <span id="mobile-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="job">
                                                        Job</label>
                                                    <input type="text" id="job" name="job" class="form-control" />
                                                    <span id="job-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="birthday">
                                                        Birthday</label>
                                                    <input type="date" id="birthday" name="birthday"
                                                        class="form-control" />
                                                    <span id="birthday-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="adress">
                                                        Adress</label>
                                                    <input type="text" id="adress" name="adress" class="form-control" />
                                                    <span id="adress-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">

                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="weight">
                                                        Weight</label>
                                                    <input type="number" id="weight" name="weight"
                                                        class="form-control" />
                                                    <span id="weight-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="height">
                                                        Height</label>
                                                    <input type="number" id="height" name="height"
                                                        class="form-control" />
                                                    <span id="height-error" class="error" style="color: red;"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <input type="hidden" id="type" name="type" value="">
                                        <button type="submit" class="btn btn-success btn-block"><span
                                                class="glyphicon glyphicon-ok"></span> OK
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- end of table responsive -->
            </div><!-- end of col -->
        </div><!-- end of row -->
    </div><!-- end of tile -->
</div><!-- end of row -->
{% endblock %}
{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
<script src="{% static 'admin_assets/js/alert.js' %}" type="text/javascript"></script>

<script type="text/javascript"
    src="{% static 'admin_assets/global/plugins/jquery.dataTables/jquery.dataTables.min.js' %}"></script>
<script type="text/javascript"
    src="{% static 'admin_assets/global/plugins/dataTables.bootstrap/dataTables.bootstrap.min.js' %}"></script>

<!--DATATABLE END -->
<!--toastr -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- <script src="{% static 'admin_assets/js/custom/index.js' %}"></script> -->

<script>

    var table = $('#datatables').DataTable({
        "processing": true,
        "serverSide": true,
        searching: false,
        lengthMenu: [5, 10, 25, 50, 75, 100],
        "columnDefs": [{ "orderable": false, "targets": [0, 5] }],
        "ajax": {
            "url": "/api/patient/",
            "type": "GET",
            data: function (d) {
                d.title = $('#title-search').val();
                d.gender = $('#gender-search').val();
                d.branch = $('#branch-search').val();

                // Add more custom parameters as needed
            }
        },
        "columns": [
            {
                targets: 0, // Target the first column
                orderable: false,
                className: 'select-checkbox', // For Select extension
                render: function (data, type, row) {
                    // 'row' contains the data for the current row
                    // Assuming 'id' is a unique identifier in your data
                    return '<div class="checkbox-style"><span><input type="checkbox"  class="checkboxes form-check-input record__select" value="' + row.id + '"></span></div>';
                }
            },
            { "data": "title" },
            { "data": "branch_field" },
            { "data": "mobile" },
            { "data": "email" },
            { "data": "gender" },
            {
                targets: 0, // Target the first column
                orderable: false,

                render: function (data, type, row) {
                    // 'row' contains the data for the current row
                    // Assuming 'id' is a unique identifier in your data
                    return '<button type="button" title="Edit" class="btn btn-xs btn-info"><i class="fa fa-edit"></i></button>'
                        + '<button type="button" title="Delete"  class="btn btn-xs btn-danger"><i class="fa fa-trash"></i></button>'
                        + '<a href="/patients/appointments/' + row.id + '" title="Appointments" class="btn default btn-xs green"><i class="fa fa-calendar" aria-hidden="true"></i></a>'
                        + '<a href="/patients/profile/' + row.id + '" title="Profile" class="btn default btn-xs yallow"><i class="fa fa-user" aria-hidden="true"></i></a>'
                        + '<a href="/patients/invoice/' + row.id + '" title="Invoice" class="btn default btn-xs purple"><i class="fa fa-eye" aria-hidden="true"></i></a>';
                }
            },
            // {
            //     "data": null,
            //     "defaultContent": '<button type="button" class="btn btn-info"><i class="fa fa-edit"></i></button>' + '&nbsp;&nbsp' +
            //         '<button type="button"  class="btn btn-danger"><i class="fa fa-trash"></i></button>' + '&nbsp;&nbsp' + '<a href="">'+ row.id +'</a>'
            // }
        ]
    });
    let id = 0;
    $('#datatables tbody').on('click', 'button', function () {
        let data = table.row($(this).parents('tr')).data();
        let class_name = $(this).attr('class');
        if (class_name == 'btn btn-xs btn-info') {
            // EDIT button
            $('#title').val(data['title']);
            $('#branch').val(data['branch']);
            $('#gender').val(data['gender']);
            $('#email').val(data['email']);
            $('#mobile').val(data['mobile']);
            $('#weight').val(data['weight']);
            $('#job').val(data['job']);
            $('#height').val(data['height']);
            $('#adress').val(data['adress']);
            $('#birthday').val(data['birthday']);
            $('#type').val('edit');
            $('#modal_title').text('EDIT');
            $("#myModal").modal();
        } else {
            // DELETE button
            $('#modal_title').text('DELETE');
            $("#confirm").modal();
        }
        id = data['id'];
    });

    $('#title-search').on('keyup', function () {
        table.column(0).search(this.value).draw();
        // table.search(this.value).draw(); 
    });

    $('#gender-search').on('change', function () {
        table.column(0).search(this.value).draw();
        // table.search(this.value).draw(); 
    });

    $('#branch-search').on('change', function () {
        table.column(0).search(this.value).draw();
        // table.search(this.value).draw(); 
    });

    $('#form').on('submit', function (e) {
        e.preventDefault();
        let $this = $(this);
        let type = $('#type').val();

        let method = '';
        let url = '/en/api/patient/';
        if (type == 'new') {
            // new
            method = 'POST';
        } else {
            // edit
            url = url + id + '/';
            method = 'PUT';
        }
        var $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
        $.ajax({
            url: url,
            method: method,
            data: $this.serialize(),
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            beforeSend: function (xhr) {
                $(".error").text("");
            }
        }).success(function (data, textStatus, jqXHR) {
            //location.reload();
            //toastr["success"]("Patient Added Successfully");
            toastr.success('Done', 'Added Successfully', {
                timeOut: 10,
                fadeOut: 10,
                onHidden: function () {
                  window.location.reload();
                }
            });
        }).error(function (er, textStatus, errorThrown) {
            var errors = $.parseJSON(er.responseText);
            $.each(errors, function (key, val) {
                $("#" + key + "-error").text(key + " " + val[0]);
                //alert(key)
            });
            //alert(errors.email); 
            //console.log(jqXHR)
        });
    });

    $('#confirm').on('click', '#delete', function (e) {
        $.ajax({
            url: '/api/patient/' + id + '/',
            method: 'DELETE',
            headers: { "X-CSRFToken": '{{csrf_token}}' },
        }).success(function (data, textStatus, jqXHR) {

            toastr.success('Done', 'Deleted Successfully', {
                timeOut: 10,
                fadeOut: 10,
                onHidden: function () {
                    window.location.reload();
                }
            });
        }).error(function (jqXHR, textStatus, errorThrown) {
            console.log(jqXHR)
        });
    });
    $('#new').on('click', function (e) {
        $('#title').val('');
        $('#type').val('new');
        $('#modal_title').text('NEW');
        $("#myModal").modal();
    });


    $(document).on('change', '.record__select', function () {
        getSelectedRecords();
    });

    // used to select all records
    $(document).on('change', '#record__select-all', function () {
        $('.record__select').prop('checked', this.checked);
        getSelectedRecords();
    });

    function getSelectedRecords() {
        var recordIds = [];

        $.each($(".record__select:checked"), function () {
            recordIds.push($(this).val());
        });

        $('#record-ids').val(JSON.stringify(recordIds));

        recordIds.length > 0
            ? $('#bulk-delete').attr('disabled', false).css('color', '#333333')
            : $('#bulk-delete').attr('disabled', true).css('color', '#E5E5E5')

    }



    // table.find('.group-checkable').change(function () {
    //     // alert("dasd");
    //     var set = jQuery(this).attr("data-set");
    //     var checked = jQuery(this).is(":checked");
    //     jQuery(set).each(function () {
    //         if (checked) {
    //             $(this).attr("checked", true);
    //         } else {
    //             $(this).attr("checked", false);
    //         }
    //     });

    //     jQuery.uniform.update(set);
    //     getSelectedRecords();
    // });
    // table.find('.record__select').change(function () {
    //     getSelectedRecords();
    // });
</script>
{% endblock %}