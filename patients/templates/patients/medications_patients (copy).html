{% extends 'layout.html'%}
{% load static %}
{% block title %}Patients{% endblock %}
{% block css %}
<link href="{% static 'admin_assets/'|add:LANGUAGE_CODE|add:'/css/style.css' %}" rel="stylesheet" type="text/css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" type="text/css" />
{% endblock %}
{% block body %}
{% include "partials/_session.html" %}
<style>
    .checkbox-style {
        margin-left: 5px;
        margin-right: 5px;
    }

    .checkboxes {
        box-sizing: border-box;
        width: 15px;
        height: 15px;
        margin: 6px;
        padding: 0;
        border: 2px solid rgb(128, 128, 128);
    }
</style>
<div class="row">






    <div class="col-md-12">
        <div class="tile shadow">
            <div>
                <a href="{% url 'patients:add_medications' %}" class="add_btn"> Add Medications To Patient <i
                        class="fa fa-plus"></i> </a>
            </div>
            <ul class="breadcrumb mt-2">
                <li class="breadcrumb-item">Patients</li>
            </ul>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <select id="patient-search" name="branch" class="form-control">
                            <option value="">Select Patients</option>
                            {% for patient in patients %}
                            <option value="{{patient.id}}">{{patient.title}}</option>
                            {%endfor%}
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <select id="tool-search" name="tool" class="form-control">
                            <option value="">Select Tools</option>
                            {% for tool in tools %}
                            <option value="{{tool.id}}">{{tool.name}}</option>
                            {%endfor%}
                        </select>
                    </div>
                </div>
            </div><!-- end of row -->
            <div class="row">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered" id="datatables" style="width: 100%;">
                        <thead>
                            <tr>

                                <th>Patient Name</th>
                                <th>Tool Name</th>
                                <th>Amount</th>
                                <th>Created At </th>
                                <th>Action</th>
                            </tr>
                        </thead>
                    </table>
                    <!-- Delete Modal -->

                    <!-- NEW and EDIT Modal -->

                </div><!-- end of table responsive -->
            </div><!-- end of col -->
        </div><!-- end of row -->
    </div><!-- end of tile -->
</div><!-- end of row -->


<!-- Delete Modal -->
<div class="modal fade" id="confirm" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Are you sure?</h4>
            </div>
            <div class="modal-body">
                <button type="button" data-dismiss="modal" class="btn btn-primary" id="delete">Delete</button>
                <button type="button" data-dismiss="modal" class="btn">Cancel</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}
{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
<script src="{% static 'admin_assets/js/alert.js' %}" type="text/javascript"></script>
<script type="text/javascript"
    src="{% static 'admin_assets/'|add:LANGUAGE_CODE|add:'/global/plugins/jquery.dataTables/jquery.dataTables.min.js' %}"></script>
<script type="text/javascript"
    src="{% static 'admin_assets/'|add:LANGUAGE_CODE|add:'/global/plugins/dataTables.bootstrap/dataTables.bootstrap.min.js' %}"></script>

<!--DATATABLE END -->
<!--toastr -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="{% static 'admin_assets/js/custom/index.js' %}"></script>




<script>

    //$(document).ready(function() {
    // Select the button by its ID and attach a click handler



    var table = $('#datatables').DataTable({
        "processing": true,
        "serverSide": true,
        searching: false,
        lengthMenu: [5, 10, 25, 50, 75, 100],
        "columnDefs": [{ "orderable": false, "targets": [0, 4] }],
        "ajax": {
            "url": "/api/medications/",
            "type": "GET",
            data: function (d) {
                d.patient = $('#patient-search').val();
                d.tool = $('#tool-search').val();

                // Add more custom parameters as needed
            }
        },
        "columns": [
            { "data": "patient_field" },
            { "data": "tool_field" },
            { "data": "amount" },
            { "data": "created_at" },
            {
                targets: 0, // Target the first column
                orderable: false,
                render: function (data, type, row) {
                    return '<button>byy</button> <a href="/patients/invoice/' + row.id + '" title="Edit" class="btn btn-xs btn-info"><i class="fa fa-edit" aria-hidden="true"></i></a>'
                        +'<form action="{% url "patients:delete_medications"  %}" style="display:inline;" method="POST">{% csrf_token %}<input type="text" name="row"  value="' + row.id + '"/> <button type="submit" title="delete" class="btn default btn-xs black"><i class="fa fa-trash"></i> </button></form>';
                }
            },
            // {
            //     "data": null,
            //     "defaultContent": '<button type="button" class="btn btn-info"><i class="fa fa-edit"></i></button>' + '&nbsp;&nbsp' +
            //         '<button type="button"  class="btn btn-danger"><i class="fa fa-trash"></i></button>' + '&nbsp;&nbsp' + '<a href="">'+ row.id +'</a>'
            // }
        ]
    });
    let id = 0;
    $('#datatables tbody').on('click', 'button', function () {
        let data = table.row($(this).parents('tr')).data();
        let class_name = $(this).attr('class');
        if (class_name == 'btn btn-xs btn-info') {
            // EDIT button
            $('#title').val(data['title']);
            $('#branch').val(data['branch']);
            $('#gender').val(data['gender']);
            $('#email').val(data['email']);
            $('#mobile').val(data['mobile']);
            $('#weight').val(data['weight']);
            $('#job').val(data['job']);
            $('#height').val(data['height']);
            $('#adress').val(data['adress']);
            $('#birthday').val(data['birthday']);
            $('#type').val('edit');
            $('#modal_title').text('EDIT');
            $("#myModal").modal();
        } else {
            // DELETE button
            $('#modal_title').text('DELETE');
            $("#confirm").modal();
        }
        id = data['id'];
    });
    $('#datatables tbody').on('click', '.show-alert-delete-box', function () {
       // $('#modal_title').text('DELETE');
        //$("#confirm").modal();
    });
    //  $(".show-alert-delete-box").click(function() {
    //      alert("Button clicked!");
    // // Add more actions to perform on click here
    // });

    $('#tool-search').on('change', function () {
        table.column(0).search(this.value).draw();
        // table.search(this.value).draw(); 
    });

    $('#patient-search').on('change', function () {
        table.column(0).search(this.value).draw();
        // table.search(this.value).draw(); 
    });

    $('#form').on('submit', function (e) {
        e.preventDefault();
        let $this = $(this);
        let type = $('#type').val();

        let method = '';
        let url = '/api/patient/';
        if (type == 'new') {
            // new
            method = 'POST';
        } else {
            // edit
            url = url + id + '/';
            method = 'PUT';
        }
        var $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
        $.ajax({
            url: url,
            method: method,
            data: $this.serialize(),
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            beforeSend: function (xhr) {
                $(".error").text("");
            }
        }).success(function (data, textStatus, jqXHR) {
            //location.reload();
            //toastr["success"]("Patient Added Successfully");
            toastr.success('Done', 'Added Successfully', {
                timeOut: 10,
                fadeOut: 10,
                onHidden: function () {
                    window.location.reload();
                }
            });
        }).error(function (er, textStatus, errorThrown) {
            var errors = $.parseJSON(er.responseText);
            $.each(errors, function (key, val) {
                $("#" + key + "-error").text(key + " " + val[0]);
                //alert(key)
            });
            //alert(errors.email); 
            //console.log(jqXHR)
        });
    });

    $('#confirm').on('click', '#delete', function (e) {
        $.ajax({
            url: '/api/patient/' + id + '/',
            method: 'DELETE',
            headers: { "X-CSRFToken": '{{csrf_token}}' },
        }).success(function (data, textStatus, jqXHR) {

            toastr.success('Done', 'Deleted Successfully', {
                timeOut: 10,
                fadeOut: 10,
                onHidden: function () {
                    window.location.reload();
                }
            });
        }).error(function (jqXHR, textStatus, errorThrown) {
            console.log(jqXHR)
        });
    });
    $('#new').on('click', function (e) {
        $('#title').val('');
        $('#type').val('new');
        $('#modal_title').text('NEW');
        $("#myModal").modal();
    });
    // table.find('.group-checkable').change(function () {
    //     // alert("dasd");
    //     var set = jQuery(this).attr("data-set");
    //     var checked = jQuery(this).is(":checked");
    //     jQuery(set).each(function () {
    //         if (checked) {
    //             $(this).attr("checked", true);
    //         } else {
    //             $(this).attr("checked", false);
    //         }
    //     });

    //     jQuery.uniform.update(set);
    //     getSelectedRecords();
    // });
    // table.find('.record__select').change(function () {
    //     getSelectedRecords();
    // });

    //});
</script>
{% endblock %}